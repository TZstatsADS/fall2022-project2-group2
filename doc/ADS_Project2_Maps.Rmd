---
title: "R Notebook"
output: html_notebook
---



```{r}
library(tidyverse)
library(geojsonio)
library(broom)
library(sf)
library(osmdata)
library(ggplot2)
library(dplyr)
library(ggnewscale)
library(RSocrata)
library(rstudioapi)
library(leaflet)
#set working directory
current_path <- rstudioapi::getActiveDocumentContext()$path
setwd(dirname(current_path))
getwd()
```


```{r}
#### Load the Restaurant dataset
data =  read.socrata(
  "https://data.cityofnewyork.us/resource/43nn-pn8j.json",
  app_token = "zTRehp1897SQtpYtBiIOUMfR4"
)

data$year <- format(data$inspection_date,"%Y") ## Extract Years

###filter the dataset
df =
  data %>%
  filter(data$year >= 2019 & zipcode!="" & dba != "") %>%
  mutate(grade=replace(grade, grade == "", NA))

head(df)
```


```{r}
# Read the geojson file containing Spatial Info
spdf_file <- geojson_read("../data/zip_code_040114.geojson", what = "sp")

stats_df = spdf_file@data

# Convert it to a spatial data frame, with zip code as index
spdf_data <- tidy(  spdf_file,
  region="ZIPCODE"  # Use ZIPCODE variable as index, the index will be named "id"
)
```




```{r}

##### None Interactive map (Population by region)
ggplot() +
  geom_polygon(data=spdf_data %>%
                 left_join(stats_df, c("id"="ZIPCODE")),
               aes(x=long,
                   y=lat,
                   group=group,
                   fill=POPULATION),
               color="white",
               size=.2) +
  theme_void() +
  coord_map() +
  scale_fill_distiller(palette = "YlGnBu", direction = 1) +
  labs(title="Population in New York City",
       subtitle="Neighborhoods are filled by population",
       fill="Population")
```



```{r}

#### Number of restaurant per ZIPCODE
Num_Rest_Code =
  df%>%
  group_by(zipcode, dba, latitude, longitude)%>%
  count() %>%
  group_by(zipcode)%>%
  count()

Critical_2019_by_Code = 
  df%>%
  filter(year == 2019)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Critical_2020_by_Code = 
  df%>%
  filter(year == 2020)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Critical_2021_by_Code = 
  df%>%
  filter(year == 2021)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Critical_2022_by_Code = 
  df%>%
  filter(year == 2022)%>%
  group_by(zipcode)%>%
  summarize(Total = n())


spdf_file_2022 = spdf_file
spdf_file_2022@data =
spdf_file_2022@data %>%
                 left_join(Critical_2022_by_Code, c("ZIPCODE"="zipcode"))



spdf_file_2019 = spdf_file
spdf_file_2019@data =
spdf_file_2019@data %>%
                 left_join(Critical_2019_by_Code, c("ZIPCODE"="zipcode"))


spdf_file_2020 = spdf_file
spdf_file_2020@data =
spdf_file_2020@data %>%
                 left_join(Critical_2020_by_Code, c("ZIPCODE"="zipcode"))

spdf_file_2021 = spdf_file
spdf_file_2021@data =
spdf_file_2021@data %>%
                 left_join(Critical_2021_by_Code, c("ZIPCODE"="zipcode"))







nc_pal= colorNumeric(palette="YlOrBr", domain= spdf_file_2019@data$Total, na.color = 'transparent')



leaflet()%>%
  addProviderTiles("CartoDB")%>%
  #### First Layer of PolyGons
  addPolygons(
    data = spdf_file_2022 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    label = ~paste0 ('Total Critical Violation : ' , Total),
    group = '2022',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
  
  #### Second Layer of PolyGons
    addPolygons(
    data = spdf_file_2021 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    
    label =~paste0 ('Total Critical Violation : ' , Total),
    group = '2021',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
    addLayersControl(overlayGroups = c("2022", "2021"))%>%
  
  
  
    addLegend( pal=nc_pal, values= spdf_file_2022$Total, opacity=0.9, title = "Critical", position = "bottomleft" )
    
```



```{r}



Total_violation = 
  df%>%
  group_by(zipcode)%>%
  summarize(Total = n())


Total_2019_by_Code = 
  df%>%
  filter(year == 2019)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Total_2020_by_Code = 
  df%>%
  filter(year == 2020)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Total_2021_by_Code = 
  df%>%
  filter(year == 2021)%>%
  group_by(zipcode)%>%
  summarize(Total = n())
  
Total_2022_by_Code = 
  df%>%
  filter(year == 2022)%>%
  group_by(zipcode)%>%
  summarize(Total = n())





##### Join datasets
spdf_file_2022 = spdf_file
spdf_file_2022@data =
spdf_file_2022@data %>%
                 left_join(Total_2022_by_Code, c("ZIPCODE"="zipcode"))



spdf_file_2019 = spdf_file
spdf_file_2019@data =
spdf_file_2019@data %>%
                 left_join(Total_2019_by_Code, c("ZIPCODE"="zipcode"))


spdf_file_2020 = spdf_file
spdf_file_2020@data =
spdf_file_2020@data %>%
                 left_join(Total_2020_by_Code, c("ZIPCODE"="zipcode"))

spdf_file_2021 = spdf_file
spdf_file_2021@data =
spdf_file_2021@data %>%
                 left_join(Total_2021_by_Code, c("ZIPCODE"="zipcode"))






##### colors
nc_pal= colorNumeric(palette="YlOrBr", domain= spdf_file_2019@data$Total, na.color = 'transparent')


leaflet()%>%
  addProviderTiles("CartoDB")%>%
  #### First Layer of PolyGons
  addPolygons(
    data = spdf_file_2022 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    label = ~paste0 ('Total Critical Violation : ' , Total),
    group = '2022',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
  
  #### Second Layer of PolyGons
    addPolygons(
    data = spdf_file_2021 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    label =~paste0 ('Total  Violation : ' , Total),
    group = '2021',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
    addLayersControl(overlayGroups = c("2022", "2021"))%>%
  
  #####Third layer
    addPolygons(
    data = spdf_file_2020 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    
    label =~paste0 ('Total  Violation : ' , Total),
    group = '2020',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
  
  ####Fourth
    addPolygons(
    data = spdf_file_2019 ,
    weight = 0.5,
    color = "black",
    stroke=TRUE ,
    opacity = 1 ,
    fillColor = ~nc_pal(Total),
    label =~paste0 ('Total  Violation : ' , Total),
    group = '2019',
    highlight = highlightOptions(weight  = 3, color = "red", bringToFront =  T)
    ) %>%
   
  
    addLayersControl(overlayGroups = c("2022", "2021",'2020', '2019'))%>%
    addLegend( pal=nc_pal, values= spdf_file_2022$Total, opacity=0.9, title = "Count of Total Violation", position = "bottomleft" )


  

```



